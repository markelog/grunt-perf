module.exports = function( grunt ) {
    var perf, listen,

        tmp = ".perf",
        app = ".perf/app",

        exec = require( "child_process" ).exec,

        express = require( "express" ),
        phantomjs = require( "grunt-lib-phantomjs" ).init( grunt ),
        git = require( "../lib/git" ),

        fs = require( "fs" ),
        path = require( "path" );

    phantomjs.on( "start", function( event ) {
        grunt.log.oklns( "Test started" );
    });

    grunt.registerTask( "perf", function() {
        var first = true,
            done = this.async(),

            options = this.options(),
            dist = app + "/" + options.dist,

            perf = new Perf( options );

        phantomjs.on( "complete", function( data, event ) {
            grunt.log.ok( "Test finished" );

            perf.put( data );

            if ( first ) {
                first = false;

                perf.erenow(function() {
                    this.checkout(function() {
                        this.prepare( dist ).start();
                    });
                });

            } else {
                perf.finish();
                done();
            }
        });

        perf.start();
    });
}
